<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä¸€é”®ä¹° PIXG - Base é“¾</title>
    <style>
        body { font-family: Arial; text-align: center; background: #f0f8ff; color: #333; }
        h1 { color: #4CAF50; }
        input { padding: 12px; font-size: 16px; width: 200px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 12px 24px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #45a049; }
        #status { margin: 20px; padding: 10px; border-radius: 5px; background: #e8f5e8; }
        .error { background: #ffebee; color: #c62828; }
        a { color: #2196F3; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>ğŸš€ PIXG ä»£å¸ä¸€é”®è´­ä¹°</h1>
    <p><strong>åˆçº¦åœ°å€:</strong> <a href="https://basescan.org/address/0xc6f8b19d3a5b85f40a0b3b8e3e73f2d" target="_blank">0xc6f8b19d3a5b85f40a0b3b8e3e73f2d</a> (å·²éªŒè¯)</p>
    <p><strong>å¼€æºä»£ç :</strong> <a href="https://github.com/MOONEY-Y/pixg-buy-dapp" target="_blank">GitHub</a></p>
    <br>
    <input id="amount" type="number" placeholder="USDT é‡‘é¢ (e.g. 0.1)" step="0.01">
    <br><br>
    <button onclick="buyPixg()">ğŸ’° ä¹° PIXG (1 USDT = 10,000 PIXG)</button>
    <p id="status"></p>

    <script type="text/javascript" src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // æ£€æŸ¥ethersåŠ è½½
        if (typeof ethers === 'undefined') {
            document.getElementById('status').innerText = 'é”™è¯¯: Ethersåº“åŠ è½½å¤±è´¥ã€‚åˆ·æ–°é¡µé¢æˆ–è¯•VPNã€‚';
            document.getElementById('status').className = 'error';
        } else {
            const PIXG_ADDRESS = '0xc6f8b19d3a5b85f40a0b3b8e3e73f2d';
            const USDT_ADDRESS = '0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2';
            let provider, signer;

            // è¿æ¥é’±åŒ…
            async function connectWallet() {
                try {
                    if (typeof window.ethereum === 'undefined') {
                        throw new Error('å®‰è£… MetaMask æ‰©å±•ï¼');
                    }
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    const network = await provider.getNetwork();
                    if (network.chainId !== 8453) {
                        throw new Error('åˆ‡æ¢åˆ° Base é“¾ (Chain ID 8453)!');
                    }
                    const usdt = new ethers.Contract(USDT_ADDRESS, ['function balanceOf(address) view returns (uint256)'], signer);
                    const balance = await usdt.balanceOf(await signer.getAddress());
                    document.getElementById('status').innerText = 'é’±åŒ…å·²è¿æ¥ï¼USDT ä½™é¢: ' + ethers.utils.formatUnits(balance, 6) + 'ã€‚å‡†å¤‡ä¹° PIXGã€‚';
                } catch (e) {
                    document.getElementById('status').innerText = 'è¿æ¥å¤±è´¥: ' + e.message + 'ã€‚åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ MetaMaskã€‚';
                    document.getElementById('status').className = 'error';
                }
            }

            // ä¹°PIXG
            async function buyPixg() {
                if (!signer) {
                    await connectWallet();
                    return;
                }
                try {
                    const amountUsdt = parseFloat(document.getElementById('amount').value);
                    if (!amountUsdt || amountUsdt <= 0) throw new Error('è¾“å…¥æœ‰æ•ˆé‡‘é¢ >0');
                    const amount = ethers.utils.parseUnits(amountUsdt.toString(), 6);
                    const deadline = Math.floor(Date.now() / 1000) + 3600;

                    document.getElementById('status').innerText = 'å‡†å¤‡ç­¾å Permit...';
                    document.getElementById('status').className = '';

                    const usdtAbi = [
                        "function permit(address owner, address spender, uint256 value, uint256 nonce, uint256 deadline) external",
                        "function nonces(address owner) view returns (uint256)"
                    ];
                    const usdt = new ethers.Contract(USDT_ADDRESS, usdtAbi, signer);

                    const nonce = await usdt.nonces(await signer.getAddress());

                    const domain = {
                        name: 'USD Tether',
                        version: '2',
                        chainId: 8453,
                        verifyingContract: USDT_ADDRESS
                    };
                    const types = {
                        Permit: [
                            { name: 'owner', type: 'address' },
                            { name: 'spender', type: 'address' },
                            { name: 'value', type: 'uint256' },
                            { name: 'nonce', type: 'uint256' },
                            { name: 'deadline', type: 'uint256' }
                        ]
                    };
                    const message = {
                        owner: await signer.getAddress(),
                        spender: PIXG_ADDRESS,
                        value: amount,
                        nonce: nonce,
                        deadline: deadline
                    };
                    const sig = await signer._signTypedData(domain, types, message);
                    const { v, r, s } = ethers.utils.splitSignature(sig);

                    document.getElementById('status').innerText = 'ç­¾åæˆåŠŸï¼å‘é€äº¤æ˜“...';

                    const pixgAbi = [
                        "function magicDeposit(uint256 amount, uint256 deadline, uint8 v, bytes32 r, bytes32 s) external"
                    ];
                    const pixg = new ethers.Contract(PIXG_ADDRESS, pixgAbi, signer);

                    const tx = await pixg.magicDeposit(amount, deadline, v, r, s, { gasLimit: 1000000 });
                    document.getElementById('status').innerText = 'äº¤æ˜“å‘é€ï¼å“ˆå¸Œ: ' + tx.hash + ' <a href="https://basescan.org/tx/' + tx.hash + '" target="_blank">æŸ¥çœ‹</a>';
                    await tx.wait();
                    document.getElementById('status').innerText = 'ğŸ‰ æˆåŠŸï¼å¾—äº† ' + (amountUsdt * 10000) + ' PIXG + LP å·²æ·»åŠ ã€‚åˆ·æ–°ä½™é¢ï¼';
                } catch (e) {
                    document.getElementById('status').innerText = 'é”™è¯¯: ' + e.message + 'ã€‚æ£€æŸ¥ USDT ä½™é¢/Network/Gasã€‚';
                    document.getElementById('status').className = 'error';
                }
            }

            // è‡ªåŠ¨è¿æ¥
            window.onload = connectWallet;
        }
    </script>
</body>
</html>
